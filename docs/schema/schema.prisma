// This schema is auto-generated based on the Room entities in the project.
// It reflects the data model used in the application's local database.

datasource db {
  provider = "sqlite" // Room uses SQLite
  url      = "file:./app_database.db"
}

generator client {
  provider = "prisma-client-js" // Placeholder; not actually used in Android
}

model Issuer {
  id   String @id
  name String

  cards Card[]

  @@map("issuers")
}

model Card {
  id                String            @id
  issuerId          String            @map("issuer_id")
  productName       String            @map("product_name")
  faces             CardFace[]
  network           CardNetwork       @default(Visa)
  paymentInstrument PaymentInstrument @default(Credit) @map("payment_instrument")
  segment           CardSegment       @default(Personal)
  annualFee         Float             @map("annual_fee")

  profileCards          ProfileCard[]
  templateCards         TemplateCard[]
  foreignTransactionFee Float          @default(0.00) @map("foreign_transaction_fee")

  issuer Issuer @relation(fields: [issuerId], references: [id], onDelete: Cascade)

  @@index([issuerId])
  @@map("cards")
}

model TemplateCard {
  id       String                @id
  cardId   String                @map("card_id")
  card     Card                  @relation(fields: [cardId], references: [id], onDelete: Cascade)
  benefits TemplateCardBenefit[]

  @@index([cardId])
  @@map("template_cards")
}

model CardFace {
  id        String  @id
  remoteUrl String
  localPath String?
  isDefault Boolean @default(false)

  card   Card?   @relation(fields: [cardId], references: [id])
  cardId String?

  @@map("card_faces")
}

model ProfileCard {
  id                   String               @id @default(cuid())
  profileId            String               @map("profile_id")
  cardId               String?              @map("card_id")
  cardFaceId           String?              @map("card_face_id")
  nickname             String?
  annualFee            Float                @map("annual_fee")
  lastFour             String?              @map("last_four")
  openDateUtc          String?              @map("open_date_utc")
  closeDateUtc         String?              @map("close_date_utc")
  statementCutUtc      String?              @map("statement_cut_utc")
  welcomeOfferProgress String?              @map("welcome_offer_progress")
  status               CardStatus           @default(Active)
  notes                String?
  subSpending          Float?               @map("sub_spending")
  subDuration          Int?                 @map("sub_duration")
  subDurationUnit      CardSubDurationUnit? @map("sub_duration_unit")

  profileCardBenefits ProfileCardBenefit[]
  offers              Offer[]
  applications        Application[]

  profile Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  card     Card?   @relation(fields: [cardId], references: [id])
  cardFace CardFace? @relation(fields: [cardFaceId], references: [id])

  @@index([profileId])
  @@index([cardId])
  @@index([cardFaceId])
  @@map("profile_cards")
}

model Benefit {
  id                 String            @id @default(cuid()) @map("_id")
  title              String?
  type               BenefitType       @default(Credit)
  amount             Float?            @map("amount")
  cap                Float?            @map("cap")
  frequency          BenefitFrequency
  category           BenefitCategory[]
  notes              String?

  // Relations
  notificationRules    NotificationRule[]
  templateCardBenefits TemplateCardBenefit[]
  profileCardBenefits  ProfileCardBenefit[]

  @@map("benefits")
}

model Transaction {
  id        String  @id @default(cuid()) @map("_id")
  benefitId String? @map("benefit_id")
  notes     String?
  dateUtc   String?
  amount    Float

  profileCardBenefit   ProfileCardBenefit? @relation(fields: [profileCardBenefitId], references: [id])
  profileCardBenefitId String?

  @@map("transactions")
}

model Tracker {
  id                   String            @id
  profileCardId         String            @map("profile_card_id")
  profileCardBenefitId  String?           @map("profile_card_benefit_id")
  offerId               String?           @map("offer_id")
  type                 TrackerSourceType
  startDateUtc          String            @map("start_date_utc")
  endDateUtc            String            @map("end_date_utc")
  manualCompleted       Boolean           @default(false) @map("manual_completed")
  notes                String?

  profileCard        ProfileCard         @relation(fields: [profileCardId], references: [id], onDelete: Cascade)
  profileCardBenefit ProfileCardBenefit? @relation(fields: [profileCardBenefitId], references: [id], onDelete: Cascade)
  offer              Offer?              @relation(fields: [offerId], references: [id], onDelete: Cascade)
  transactions       TrackerTransaction[]

  @@index([profileCardId])
  @@index([profileCardBenefitId])
  @@index([offerId])
  @@unique([profileCardBenefitId, startDateUtc, endDateUtc])
  @@unique([offerId, startDateUtc, endDateUtc])
  @@map("trackers")
}

model TrackerTransaction {
  id        String  @id
  trackerId String  @map("tracker_id")
  amount    Float
  dateUtc   String  @map("date_utc")
  notes     String?

  tracker Tracker @relation(fields: [trackerId], references: [id], onDelete: Cascade)

  @@index([trackerId])
  @@map("tracker_transactions")
}

model Offer {
  id             String  @id @default(cuid())
  profileCardId  String  @map("profile_card_id")
  title          String
  note           String?
  startDateUtc   String? @map("start_date_utc")
  endDateUtc     String? @map("end_date_utc")
  type           String
  multiplierRate Float?  @map("multiplier_rate")
  minSpend       Float?  @map("min_spend")
  maxCashBack    Float?  @map("max_cash_back")
  status         String  @default("active")

  // Relations
  profileCard ProfileCard @relation(fields: [profileCardId], references: [id], onDelete: Cascade)

  @@index([profileCardId])
  @@map("offers")
}

model Application {
  id                   String  @id @default(cuid())
  profileCardId        String  @map("profile_card_id")
  applicationDateUtc   String? @map("application_date_utc")
  decisionDateUtc      String? @map("decision_date_utc")
  status               String
  creditBureau         String? @map("credit_bureau")
  reconsiderationNotes String? @map("reconsideration_notes")
  welcomeOfferTerms    String? @map("welcome_offer_terms")

  // Relations
  profileCard ProfileCard @relation(fields: [profileCardId], references: [id], onDelete: Cascade)

  @@index([profileCardId])
  @@map("applications")
}

model NotificationRule {
  id        String  @id @default(cuid())
  benefitId String  @map("benefit_id")
  trigger   String
  channel   String
  enabled   Boolean

  // Relations
  benefit Benefit @relation(fields: [benefitId], references: [id], onDelete: Cascade)

  @@index([benefitId])
  @@map("notification_rules")
}

enum CardNetwork {
  Visa
  Mastercard
  Discover
  Amex
}

enum PaymentInstrument {
  Credit
  Debit
  Charge
}

enum CardSegment {
  Personal
  Business
}

enum CardStatus {
  Active
  Closed
  Pending
}

enum CardSubDurationUnit {
  Day
  Month
}

model Profile {
  id     String        @id @default(cuid())
  userId String?
  name   String
  cards  ProfileCard[]

  @@map("profiles")
}

model ProfileCardBenefit {
  id            String        @id
  profileCardId String        @map("profile_card_id")
  benefitId     String        @map("benefit_id")
  startDateUtc  String?       @map("start_date_utc")
  endDateUtc    String?       @map("end_date_utc")
  transactions  Transaction[]

  profileCard ProfileCard @relation(fields: [profileCardId], references: [id], onDelete: Cascade)
  benefit     Benefit     @relation(fields: [benefitId], references: [id], onDelete: Cascade)

  @@index([profileCardId, benefitId])
  @@map("profile_card_benefits")
}

model TemplateCardBenefit {
  id             String @id
  templateCardId String @map("template_card_id")
  benefitId      String @map("benefit_id")

  templateCard TemplateCard @relation(fields: [templateCardId], references: [id], onDelete: Cascade)
  benefit      Benefit      @relation(fields: [benefitId], references: [id], onDelete: Cascade)

  @@unique([benefitId])
  @@index([benefitId])
  @@index([templateCardId])
  @@map("template_card_benefits")
}

enum BenefitCategory {
  Dining
  OnlineShopping
  Grocery
  Restaurant
  DrugStore
  Travel
  Gas
  EVCharging
  Streaming
  Transit
  Utilities
  Others
  RideShare
  Supermarket
  RetailStore
}

enum BenefitFrequency {
  Monthly
  Quarterly
  SemiAnnually
  Annually
  EveryTransaction
  EveryAnniversary
}

enum BenefitType {
  Credit
  Multiplier
}

enum TrackerSourceType {
  Benefit
  Offer
}
